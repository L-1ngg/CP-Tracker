# CP-Tracker 开发文档

> 算法竞赛数据聚合与分析平台

---

## 1. 项目愿景与核心功能

### 1.1 项目定位

CP-Tracker 是一个**一站式算法竞赛情报中心**。系统不负责判题，而是作为"连接器"，抓取 Codeforces (CF)、AtCoder (AT)、NowCoder (NK) 等主流平台的比赛、题目和用户提交记录，经过清洗后为用户提供数据分析服务。

### 1.2 核心功能

| 功能模块 | 描述 |
|---------|------|
| **统一竞赛日历** | 聚合各平台近期比赛，一站式查看所有 OJ 的比赛安排 |
| **全网能力画像** | 基于用户在多个平台的表现，生成统一的能力雷达图和积分曲线 |
| **可视化训练分析** | 每日提交热力图、标签专项分析、补题进度追踪 |
| **极客博客** | 支持 Markdown/LaTeX 的技术分享社区 |

---

## 2. 系统总体架构

架构重点为 **I/O 密集型（爬虫）** 和 **数据分析密集型**。

### 2.1 服务拆分

| 服务名称 | 端口 | 核心职责 | 技术关键点 |
|---------|------|---------|-----------|
| **Gateway** | 8080 | 流量入口、鉴权、限流 | Spring Cloud Gateway, JWT 解析 |
| **Auth Service** | 8081 | 用户注册、登录、第三方账号绑定 | Spring Security, OAuth2 |
| **Crawler Service** | 8082 | 多平台数据抓取、清洗、入库 | Quartz/Spring Schedule, Jsoup, Selenium |
| **Analysis Service** | 8083 | 数据聚合、Rating 计算、图表数据生成 | 异步计算, Redis 缓存热点数据 |
| **Core Service** | 8084 | 比赛日历管理、题目元数据、博客系统 | CRUD, Elasticsearch (可选) |
| **Nacos** | 8848 | 配置中心、服务注册与发现 | 动态调整爬虫频率、代理 IP 池配置 |

### 2.2 数据流向

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据采集流程                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐    定时抓取    ┌──────────────┐    写入    ┌───────────┐ │
│  │  Codeforces  │ ─────────────► │              │ ─────────► │           │ │
│  │  NowCoder    │                │   Crawler    │            │ PostgreSQL│ │
│  │  AtCoder     │                │   Service    │            │ (原始数据) │ │
│  └──────────────┘                └──────────────┘            └───────────┘ │
│                                         │                                   │
│                                         │ 发送消息                          │
│                                         ▼                                   │
│                                  ┌──────────────┐                          │
│                                  │ Redis Stream │                          │
│                                  └──────────────┘                          │
│                                         │                                   │
│                                         │ 监听消费                          │
│                                         ▼                                   │
│  ┌──────────────┐    读取缓存    ┌──────────────┐    更新    ┌───────────┐ │
│  │   Frontend   │ ◄───────────── │   Analysis   │ ─────────► │ PostgreSQL│ │
│  │   (Next.js)  │                │   Service    │            │ (分析结果) │ │
│  └──────────────┘                └──────────────┘            └───────────┘ │
│         │                               │                                   │
│         │                               │ 缓存                              │
│         │                               ▼                                   │
│         │                        ┌──────────────┐                          │
│         └───────────────────────►│    Redis     │                          │
│              请求 Gateway         │   (缓存)     │                          │
│                                  └──────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心模块详细设计

### 3.1 爬虫服务 (Crawler Service)

这是系统的"心脏"。由于各大 OJ 的反爬策略不同，需采用 **策略模式 (Strategy Pattern)** 设计。

#### 3.1.1 架构设计

**Fetcher 接口定义**

```java
public interface PlatformFetcher {
    /**
     * 获取比赛列表
     */
    List<ContestDTO> fetchContests();

    /**
     * 获取用户提交记录
     */
    List<SubmissionDTO> fetchUserSubmissions(String handle);

    /**
     * 获取题目详情
     */
    ProblemDTO fetchProblem(String problemId);
}
```

**平台实现策略**

| 平台 | 数据获取方式 | 注意事项 |
|-----|-------------|---------|
| **Codeforces** | 官方 REST API | API 限制 5次/秒，需实现令牌桶限流 |
| **NowCoder** | Jsoup 解析 HTML | 部分动态页面需 Selenium |
| **AtCoder** | Jsoup + Selenium | 无官方 API，需解析 HTML |

**代理池配置 (Nacos)**

```yaml
crawler:
  proxy:
    enabled: true
    pool:
      - "http://proxy1.example.com:8080"
      - "http://proxy2.example.com:8080"
    rotation-strategy: ROUND_ROBIN
```

#### 3.1.2 调度策略 (Quartz)

| 任务类型 | 执行时间 | 说明 |
|---------|---------|------|
| **全量同步** | 每天凌晨 2:00 | 同步未来 30 天的比赛列表 |
| **增量同步** | 用户触发 | 单用户提交记录增量抓取，走高优先级队列 |

### 3.2 分析服务 (Analysis Service)

负责将原始的"提交记录"转化为"可视化指标"。

#### 3.2.1 统一能力评分 (Unified Skill Rating)

不同平台的积分无法直接比较（CF 1500 != AtCoder 1500）。

**算法选型**：采用 **Elo Rating** 或 **Glicko-2** 算法的变体。

**归一化公式**：建立转换公式，将各平台分值映射到本系统的标准分（以 CF 分数为基准）。

```
Score_total = w1 × R_CF + w2 × R_NK + w3 × R_AT
```

其中 `w1`, `w2`, `w3` 为各平台权重系数。

#### 3.2.2 标签能力分析

- 解析题目的 Tags（如 `dp`, `graphs`, `math`）
- 计算用户在特定 Tag 下的 AC 率和平均难度
- 存入 `user_tag_stats` 表，用于生成雷达图

### 3.3 博客系统 (Core Service)

轻量级 CMS，服务于题解和经验分享。

| 功能 | 实现方案 |
|-----|---------|
| **内容存储** | Markdown 存入 PostgreSQL 的 `TEXT` 字段 |
| **图片存储** | MinIO 对象存储 |
| **关联功能** | 文章可关联 `Problem ID` 或 `Contest ID` |

---

## 4. 数据库设计 (PostgreSQL)

采用 Schema 隔离业务。

### 4.1 Schema: `crawler` (原始数据)

```sql
-- 题目表（全网统一）
CREATE TABLE crawler.problems (
    id BIGSERIAL PRIMARY KEY,
    platform VARCHAR(20) NOT NULL,    -- 'CODEFORCES', 'NOWCODER', 'ATCODER'
    remote_id VARCHAR(50) NOT NULL,   -- 平台原始ID，如 '118A'
    title VARCHAR(255),
    url VARCHAR(500),
    difficulty INTEGER,               -- 转换后的难度分
    tags TEXT,                        -- 标签数组
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(platform, remote_id)
);

-- 外部账号映射
CREATE TABLE crawler.user_handles (
    user_id BIGINT REFERENCES public.users(id),
    platform VARCHAR(20),
    handle VARCHAR(100),              -- 用户的平台 ID
    last_fetched TIMESTAMP,           -- 上次爬取时间
    PRIMARY KEY (user_id, platform)
);

-- 提交记录表
CREATE TABLE crawler.submissions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    platform VARCHAR(20) NOT NULL,
    problem_id BIGINT REFERENCES crawler.problems(id),
    verdict VARCHAR(50),              -- 'AC', 'WA', 'TLE' 等
    language VARCHAR(50),
    submission_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
) PARTITION BY RANGE (submission_time);
```

### 4.2 Schema: `analytics` (分析结果)

```sql
-- 每日提交统计（用于热力图）
CREATE TABLE analytics.daily_activity (
    user_id BIGINT,
    date DATE,
    count INTEGER,
    platform_breakdown JSONB,         -- {"cf": 5, "nk": 2}
    PRIMARY KEY (user_id, date)
);

-- 技能维度分析（用于雷达图）
CREATE TABLE analytics.skill_radar (
    user_id BIGINT,
    tag VARCHAR(50),                  -- 'DP', 'Geometry'
    rating DOUBLE PRECISION,          -- 计算后的能力值 (0-100)
    solved_count INTEGER,
    UNIQUE(user_id, tag)
);

-- 用户综合评分
CREATE TABLE analytics.user_rating (
    user_id BIGINT PRIMARY KEY,
    unified_rating INTEGER,           -- 统一评分
    cf_rating INTEGER,
    nk_rating INTEGER,
    at_rating INTEGER,
    updated_at TIMESTAMP DEFAULT NOW()
);
```

---

## 5. 前端架构 (Next.js + Shadcn/ui)

### 5.1 页面路由规划 (App Router)

| 路由 | 功能描述 |
|-----|---------|
| `/dashboard` | 个人概览（雷达图、热力图、近期比赛提醒） |
| `/contests` | 全网比赛日历（支持按平台、规则筛选） |
| `/problems` | 聚合题库（支持跳转原站） |
| `/blog` | 博客列表 |
| `/u/[username]` | 用户公开画像页 |

### 5.2 可视化组件实现

使用 **Recharts** (Shadcn/ui 默认集成) 或 **ECharts** 实现图表。

#### A. 能力雷达图 (Skill Radar)

```tsx
// components/SkillRadar.tsx
import { Radar, RadarChart, PolarGrid, PolarAngleAxis } from 'recharts';

const data = [
  { subject: '动态规划', A: 120, fullMark: 150 },
  { subject: '图论', A: 98, fullMark: 150 },
  { subject: '数学', A: 86, fullMark: 150 },
  // ...
];

export function SkillRadar() {
  return (
    <RadarChart cx={300} cy={250} outerRadius={150} width={600} height={500} data={data}>
      <PolarGrid />
      <PolarAngleAxis dataKey="subject" />
      <Radar name="My Skill" dataKey="A" stroke="#8884d8" fill="#8884d8" fillOpacity={0.6} />
    </RadarChart>
  );
}
```

#### B. 提交热力图 (Activity Heatmap)

使用 `react-activity-calendar` 模仿 GitHub 风格。

```tsx
// components/ActivityHeatmap.tsx
import ActivityCalendar from 'react-activity-calendar';

const data = [
  { date: '2024-01-01', count: 12, level: 3 },
  { date: '2024-01-02', count: 5, level: 1 },
  // ...
];

export function ActivityHeatmap() {
  return (
    <ActivityCalendar
      data={data}
      theme={{
        light: ['#f0f0f0', '#c4edde', '#7ac7c4', '#f73859', '#384259'],
      }}
    />
  );
}
```

---

## 6. 开发实施步骤

> **原则**：后端微服务全部构建并测试通过后，再进行前端开发

### 第一阶段：基础设施搭建

1. **Docker 环境准备**
   - 编写 `docker-compose.yml` 配置基础设施
   - 启动 PostgreSQL 16、Redis 7.2、MinIO、Nacos 2.3
   - 验证各服务连通性

2. **数据库初始化**
   - 创建 `crawler` 和 `analytics` 两个 Schema
   - 执行建表 SQL，创建索引
   - 配置分区表（submissions）

### 第二阶段：后端核心服务开发

1. **API Gateway 服务**
   - 搭建 Spring Cloud Gateway 项目
   - 配置路由规则、JWT 鉴权过滤器
   - 集成 Nacos 服务发现
   - **测试**：验证路由转发和鉴权拦截

2. **Auth Service 认证服务**
   - 实现用户注册/登录接口
   - JWT Token 生成与刷新机制
   - 第三方平台账号绑定（CF/NK/AT Handle）
   - **测试**：单元测试 + Postman 接口测试

3. **Core Service 核心服务**
   - 比赛日历 CRUD
   - 题目元数据管理
   - 博客系统（文章发布、MinIO 图片上传）
   - **测试**：JUnit 单元测试 + 集成测试

### 第三阶段：后端爬虫与分析服务

1. **Crawler Service 爬虫服务**
   - 实现 `PlatformFetcher` 策略接口
   - Codeforces API 对接（令牌桶限流）
   - NowCoder/AtCoder HTML 解析（Jsoup + Selenium）
   - Quartz 定时任务调度
   - **测试**：Mock 测试 + 真实 API 联调

2. **Analysis Service 分析服务**
   - Redis Stream 消息消费
   - 统一 Rating 计算算法
   - 标签能力分析、每日活跃度统计
   - 缓存策略实现（Redis TTL）
   - **测试**：数据准确性验证 + 性能测试

### 第四阶段：后端集成测试

1. **服务联调**
   - 全链路测试：Gateway → Auth → Core/Crawler/Analysis
   - 验证服务注册与发现（Nacos）
   - 压力测试：模拟高并发爬取场景

2. **API 文档输出**
   - 整理所有 REST API 接口文档
   - 为前端开发提供 Mock 数据

### 第五阶段：前端开发

1. **项目初始化**
   - 创建 Next.js 15 项目（App Router）
   - 集成 Shadcn/ui + Tailwind CSS
   - 配置 API 代理和环境变量

2. **页面开发**
   - Dashboard 个人概览页（雷达图、热力图）
   - Contests 比赛日历页
   - Problems 题库聚合页
   - Blog 博客系统
   - User Profile 用户画像页

3. **联调与优化**
   - 对接后端 API，替换 Mock 数据
   - 响应式适配、性能优化
   - E2E 测试（Playwright）

---

## 7. 关键技术难点解决方案

### Q1: 如何应对反爬？

| 平台 | 解决方案 |
|-----|---------|
| **Codeforces** | 使用官方 API 是安全的，但需严格遵守 QPS 限制（5次/秒）。若需抓取题目 HTML，需携带随机 User-Agent |
| **NowCoder** | 必须管理 Cookie。对于需要登录的题目，可以考虑模拟登录或仅抓取公开题目 |
| **AtCoder** | 类似 NowCoder，需要处理登录态和动态渲染 |

### Q2: 数据量大了怎么查？

提交记录表 (`submissions`) 会非常大。

**解决方案**：
- 对该表按 `submission_time` 进行 **PostgreSQL 分区 (Partitioning)**
- 分析服务只在夜间做重计算，将结果存入 `analytics` 模式下的汇总表
- 前端只查汇总表，不查明细表

### Q3: 博客图片怎么存？

使用 **MinIO** 对象存储：
- 后端不经手文件流，只负责鉴权和生成上传链接
- 前端直接 PUT 文件到 MinIO
- 减轻后端带宽压力

---

## 8. 技术栈总结

> **版本选型原则**：优先选择 LTS 版本或经过生产验证的稳定版本，确保组件间兼容性

### 后端

| 组件 | 版本 | 说明 |
|-----|------|------|
| Java | 21 (LTS) | 2023.09 发布，长期支持至 2031 |
| Spring Boot | 3.3.x | 兼容 Java 21，Spring Cloud 2023.x |
| Spring Cloud | 2023.0.x | 与 Spring Boot 3.3 兼容 |
| Spring Cloud Alibaba | 2023.0.x | 与 Spring Cloud 2023.0 兼容 |
| Nacos | 2.3.x | 服务发现 + 配置中心 |
| PostgreSQL | 16 | 2023.09 发布，性能提升显著 |
| Redis | 7.2 | 2023.08 发布，Stream 功能完善 |
| MinIO | RELEASE.2024-xx | 使用最新稳定版 |
| Jsoup | 1.17.x | HTML 解析 |
| Selenium | 4.x | Headless Chrome 支持 |
| Quartz | 2.3.x | 定时任务调度 |

### 前端

| 组件 | 版本 | 说明 |
|-----|------|------|
| Node.js | 20 (LTS) | 2023.10 进入 LTS，支持至 2026 |
| Next.js | 15.x | 2024.10 发布，App Router 稳定 |
| React | 19.x | 与 Next.js 15 兼容 |
| TypeScript | 5.x | 类型安全 |
| Tailwind CSS | 3.4.x | 与 Next.js 15 兼容 |
| Shadcn/ui | latest | 基于 Radix UI，按需安装 |
| Recharts | 2.x | React 图表库 |
| TanStack Query | 5.x | 数据请求管理（原 React Query） |
| Zustand | 5.x | 轻量状态管理 |

### 基础设施

| 组件 | 版本 | 说明 |
|-----|------|------|
| Docker | 24.x+ | 容器运行时 |
| Docker Compose | 2.x | 多容器编排 |
| Nginx | 1.25.x | 反向代理（可选） |

### 版本兼容性矩阵

```
Spring Boot 3.3.x
    ├── Spring Cloud 2023.0.x
    │       └── Spring Cloud Alibaba 2023.0.x
    │               └── Nacos Client 2.3.x
    ├── Java 21 (LTS)
    └── Spring Data JPA (Hibernate 6.x)

Next.js 15.x
    ├── React 19.x
    ├── Node.js 20 (LTS)
    └── Tailwind CSS 3.4.x
```

---

## 附录

### A. 目录结构

```
CP-Tracker/
├── api-gateway/              # API 网关服务
├── services/
│   ├── auth-service/         # 认证服务
│   ├── crawler-service/      # 爬虫服务
│   ├── analysis-service/     # 分析服务
│   └── core-service/         # 核心业务服务
├── frontend/                 # Next.js 前端
├── docker/                   # Docker 配置
└── docs/                     # 文档
```

### B. 参考资源

- [Codeforces API 文档](https://codeforces.com/apiHelp)
- [Recharts 官方文档](https://recharts.org/)
- [Shadcn/ui 组件库](https://ui.shadcn.com/)

---

> 文档版本: v1.0
> 最后更新: 2025-12

